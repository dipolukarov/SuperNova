(function(a){a.fn.bPopup=function(s,B){if(a.isFunction(s)){B=s;s=null}var G=a.extend({},a.fn.bPopup.defaults,s);if(!G.scrollBar){a("html").css("overflow","hidden")}var f=this,N=a(document),C=window,O=a(C),n=L(),j=J(),A="__b-popup",I=(/OS 6(_\d)+/i).test(navigator.userAgent),q=200,e=0,z,p,m,x,t,D,Q,c,b,i;f.close=function(){G=this.data("bPopup");z=A+O.data("bPopup")+"__";E()};return f.each(function(){if(a(this).data("bPopup")){return}H()});function H(){h(G.onOpen);e=(O.data("bPopup")||0)+1,z=A+e+"__",m=G.position[1]!=="auto",x=G.position[0]!=="auto",t=G.positionStyle==="fixed",c=f.outerHeight(true),b=f.outerWidth(true);G.loadUrl?u():r()}function u(){G.contentContainer=a(G.contentContainer||f);switch(G.content){case ("iframe"):var d=a('<iframe class="b-iframe" '+G.iframeAttr+"></iframe>");d.appendTo(G.contentContainer);c=f.outerHeight(true);b=f.outerWidth(true);r();d.attr("src",G.loadUrl);h(G.loadCallback);break;case ("image"):r();a("<img />").load(function(){h(G.loadCallback);g(a(this))}).attr("style","width:768px;height:432px;cursor:pointer;").attr("src",G.loadUrl).attr("onClick",'var win = window.open("'+G.loadUrl+'");win.focus();return false;').hide().appendTo(G.contentContainer);break;default:r();a('<div class="b-ajax-wrapper"></div>').load(G.loadUrl,G.loadData,function(){h(G.loadCallback);g(a(this))}).hide().appendTo(G.contentContainer);break}}function r(){if(G.modal){a('<div class="b-modal '+z+'"></div>').css({backgroundColor:G.modalColor,position:"fixed",top:0,right:0,bottom:0,left:0,opacity:0,zIndex:G.zIndex+e}).appendTo(G.appendTo).fadeTo(G.speed,G.opacity)}y();f.data("bPopup",G).data("id",z).css({left:G.transition=="slideIn"||G.transition=="slideBack"?(G.transition=="slideBack"?N.scrollLeft()+j:(Q+b)*-1):F(!(!G.follow[0]&&x||t)),position:G.positionStyle||"absolute",top:G.transition=="slideDown"||G.transition=="slideUp"?(G.transition=="slideUp"?N.scrollTop()+n:D+c*-1):l(!(!G.follow[1]&&m||t)),"z-index":G.zIndex+e+1}).each(function(){if(G.appending){a(this).appendTo(G.appendTo)}});M(true)}function E(){if(G.modal){a(".b-modal."+f.data("id")).fadeTo(G.speed,0,function(){a(this).remove()})}P();M();return false}function g(R){var d=R.width(),w=R.height(),o={};G.contentContainer.css({height:w,width:d});if(w>=f.height()){o.height=f.height()}if(d>=f.width()){o.width=f.width()}c=f.outerHeight(true),b=f.outerWidth(true);y();G.contentContainer.css({height:"auto",width:"auto"});o.left=F(!(!G.follow[0]&&x||t)),o.top=l(!(!G.follow[1]&&m||t));f.animate(o,250,function(){R.show();p=v()})}function K(){O.data("bPopup",e);f.delegate(".bClose, ."+G.closeClass,"click."+z,E);if(G.modalClose){a(".b-modal."+z).css("cursor","pointer").bind("click",E)}if(!I&&(G.follow[0]||G.follow[1])){O.bind("scroll."+z,function(){if(p){f.dequeue().animate({left:G.follow[0]?F(!t):"auto",top:G.follow[1]?l(!t):"auto"},G.followSpeed,G.followEasing)}}).bind("resize."+z,function(){n=L();j=J();p=v();if(p){clearTimeout(i);i=setTimeout(function(){y();f.dequeue().each(function(){if(t){a(this).css({left:Q,top:D})}else{a(this).animate({left:G.follow[0]?F(true):"auto",top:G.follow[1]?l(true):"auto"},G.followSpeed,G.followEasing)}})},50)}})}if(G.escClose){N.bind("keydown."+z,function(d){if(d.which==27){E()}})}}function P(){if(!G.scrollBar){a("html").css("overflow","auto")}a(".b-modal."+z).unbind("click");N.unbind("keydown."+z);O.unbind("."+z).data("bPopup",(O.data("bPopup")-1>0)?O.data("bPopup")-1:null);f.undelegate(".bClose, ."+G.closeClass,"click."+z,E).data("bPopup",null)}function M(o){switch(o?G.transition:G.transitionClose||G.transition){case"slideIn":d({left:o?F(!(!G.follow[0]&&x||t)):N.scrollLeft()-(b||f.outerWidth(true))-q});break;case"slideBack":d({left:o?F(!(!G.follow[0]&&x||t)):N.scrollLeft()+j+q});break;case"slideDown":d({top:o?l(!(!G.follow[1]&&m||t)):N.scrollTop()-(c||f.outerHeight(true))-q});break;case"slideUp":d({top:o?l(!(!G.follow[1]&&m||t)):N.scrollTop()+n+q});break;default:f.stop().fadeTo(G.speed,o?1:0,function(){k(o)})}function d(w){f.css({display:"block",opacity:1}).animate(w,G.speed,G.easing,function(){k(o)})}}function k(d){if(d){K();h(B);if(G.autoClose){setTimeout(E,G.autoClose)}}else{f.hide();h(G.onClose);if(G.loadUrl){G.contentContainer.empty();f.css({height:"auto",width:"auto"})}}}function F(d){return d?Q+N.scrollLeft():Q}function l(d){return d?D+N.scrollTop():D}function h(d){a.isFunction(d)&&d.call(f)}function y(){D=m?G.position[1]:Math.max(0,((n-f.outerHeight(true))/2)-G.amsl),Q=x?G.position[0]:(j-f.outerWidth(true))/2,p=v()}function v(){return n>f.outerHeight(true)&&j>f.outerWidth(true)}function L(){return C.innerHeight||O.height()}function J(){return C.innerWidth||O.width()}};a.fn.bPopup.defaults={amsl:50,appending:true,appendTo:"body",autoClose:false,closeClass:"b-close",content:"ajax",contentContainer:false,easing:"swing",escClose:true,follow:[true,true],followEasing:"swing",followSpeed:500,iframeAttr:'scrolling="no" frameborder="0"',loadCallback:false,loadData:false,loadUrl:false,modal:true,modalClose:true,modalColor:"#000",onClose:false,onOpen:false,opacity:0.7,position:["auto","auto"],positionStyle:"absolute",scrollBar:true,speed:250,transition:"fadeIn",transitionClose:false,zIndex:9997}})(jQuery);